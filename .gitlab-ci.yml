stages:
  - build_and_push

variables:
  IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
  LATEST: "$CI_REGISTRY_IMAGE:latest"
  DOCKER_TLS_CERTDIR: ""

# Build and push in a single job to avoid cross-job Docker daemon issues
build_and_push:
  stage: build_and_push
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375/
  before_script:
    - echo "Logging in to registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker info
  script:
    - docker build -t "$IMAGE" .
    - docker tag "$IMAGE" "$LATEST"
    - docker push "$IMAGE"
    - docker push "$LATEST"
  tags: [docker]
  # some shared runners require privileged for dind
  privileged: true
  only:
    - main

# Kaniko alternative for non-privileged runners (will run if `USE_KANIKO` variable is set)
build_with_kaniko:
  stage: build_and_push
  image:
    name: gcr.io/kaniko-project/executor:latest
    entrypoint: [""]
  variables:
    # destination is the registry path; Kaniko needs Docker config or env creds
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - mkdir -p /kaniko/.docker
    - echo '{"auths": {"'$CI_REGISTRY'": {"auth": "'$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)'"}}}' > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $IMAGE --destination $LATEST
    - echo "Build completed with Kaniko"
    - echo "Pushing images to registry"
    - echo "Done"
  rules:
    - if: '$USE_KANIKO == "true"'
  only:
    - main
